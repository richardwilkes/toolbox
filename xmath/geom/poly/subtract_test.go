// Copyright Â©2016-2023 by Richard A. Wilkes. All rights reserved.
//
// This Source Code Form is subject to the terms of the Mozilla Public
// License, version 2.0. If a copy of the MPL was not distributed with
// this file, You can obtain one at http://mozilla.org/MPL/2.0/.
//
// This Source Code Form is "Incompatible With Secondary Licenses", as
// defined by the Mozilla Public License, version 2.0.

package poly_test

import (
	"testing"

	"github.com/richardwilkes/toolbox/check"
)

func TestSubtract(t *testing.T) {
	tests := []testCase{
		{
			name: "subtract #1",
			subject: Polygon{{
				{160.09449516387843, 200.37992407997774},
				{90.09449516387845, 200.37992407997774},
				{55.094495163878435, 139.75814581506702},
				{90.0944951638784, 79.13636755015634},
			}},
			clipping: Polygon{{
				{82.84661138052363, 131.51881422166852},
				{66.59206311550543, 159.6725176707606},
				{90.09449516387845, 200.37992407997774},
				{160.09449516387843, 200.37992407997774},
			}},
			expected: Polygon{{
				{82.84661138052363, 131.51881422166852},
				{66.59206311550543, 159.6725176707606},
				{55.094495163878435, 139.75814581506702},
				{90.0944951638784, 79.13636755015634},
				{160.09449516387843, 200.37992407997774},
			}},
		},
		{
			name: "subtract #2",
			subject: Polygon{{
				{2.500054958553072, 20.615428910374025},
				{42.500054958553065, -19.38457108962598},
				{82.50005495855308, 20.61542891037402},
				{42.50005495855307, 60.61542891037402},
			}},
			clipping: Polygon{{
				{7.604714313123809, 25.720088264944764},
				{32.55986001707135, 50.6752339688923},
				{36.852886624296644, 46.382207361667014},
				{11.897740920349097, 21.42706165771947},
			}},
			expected: Polygon{{
				{42.50005495855307, 60.61542891037402},
				{32.55986001707135, 50.6752339688923},
				{36.852886624296644, 46.382207361667014},
				{11.897740920349097, 21.42706165771947},
				{7.604714313123809, 25.720088264944764},
				{2.500054958553072, 20.615428910374025},
				{42.500054958553065, -19.38457108962598},
				{82.50005495855308, 20.61542891037402},
			}},
		},
		{
			name: "subtract #3",
			subject: Polygon{{
				{38.5721239031346, 172.33955556881023},
				{39.99999999999999, 171.3397459621556},
				{41.57979856674331, 170.60307379214092},
				{43.2635182233307, 170.15192246987792},
				{45, 170},
				{46.7364817766693, 170.15192246987792},
				{48.42020143325668, 170.60307379214092},
				{50, 171.3397459621556},
				{51.42787609686539, 172.33955556881023},
			}},
			clipping: Polygon{{
				{51.42787609686539, 172.33955556881023},
				{50, 171.3397459621556},
				{48.42020143325668, 170.60307379214092},
				{46.7364817766693, 170.15192246987792},
				{45, 170},
				{43.2635182233307, 170.15192246987792},
				{42.78116786015871, 170.28116786015872},
				{42.65192246987792, 170.7635182233307},
				{42.5, 172},
			}},
			expected: Polygon{{
				{51.42787609686539, 172.33955556881023},
				{42.5, 172},
				{42.65192246987792, 170.7635182233307},
				{42.78116786015871, 170.28116786015872},
				{41.57979856674331, 170.60307379214092},
				{39.99999999999999, 171.3397459621556},
				{38.5721239031346, 172.33955556881023},
			}},
		},
		{
			name:     "subtract #4",
			subject:  Polygon{{{24, 7}, {36, 7}, {36, 23}, {24, 23}}},
			clipping: circle,
			expected: Polygon{{
				{24, 23.00000000000004},
				{24.83622770614123, 22.956175162946227},
				{25.66329352654208, 22.825180805870485},
				{26.472135954999587, 22.608452130361268},
				{27.253893144606412, 22.308363661140845},
				{28.00000000000001, 21.928203230275546},
				{28.702282018339798, 21.472135954999615},
				{29.35304485087088, 20.945158603819188},
				{29.94515860381917, 20.353044850870898},
				{30.472135954999597, 19.702282018339815},
				{30.92820323027553, 19.00000000000003},
				{31.308363661140827, 18.25389314460643},
				{31.60845213036125, 17.472135954999604},
				{31.825180805870467, 16.6632935265421},
				{31.95617516294621, 15.83622770614125},
				{32.00000000000002, 15.00000000000002},
				{31.95617516294621, 14.16377229385879},
				{31.825180805870467, 13.33670647345794},
				{31.60845213036125, 12.527864045000435},
				{31.308363661140827, 11.746106855393611},
				{30.92820323027553, 11.00000000000001},
				{30.472135954999597, 10.297717981660224},
				{29.94515860381917, 9.646955149129141},
				{29.35304485087088, 9.054841396180851},
				{28.702282018339798, 8.527864045000424},
				{28.00000000000001, 8.071796769724493},
				{27.253893144606412, 7.691636338859195},
				{26.472135954999587, 7.391547869638773},
				{25.66329352654208, 7.174819194129555},
				{24.83622770614123, 7.043824837053814},
				{24, 7},
				{36, 7},
				{36, 23},
			}},
		},
		{
			name:     "subtract #5",
			subject:  Polygon{{{114, 0}, {161, 0}, {114, 168}}},
			clipping: Polygon{{{99, 164}, {114, 108}, {121, 164}}},
			expected: Polygon{
				{{114, 168}, {114, 164}, {115.11904761904762, 164}},
				{{119.18382352941177, 149.47058823529412}, {114, 108}, {114, 0}, {161, 0}},
			},
		},
		{
			name: "subtract #6",
			subject: Polygon{{
				{426694.6365274183, -668547.1611580737},
				{426714.57523030025, -668548.9238652373},
				{426745.39648089616, -668550.4651249861},
			}},
			clipping: Polygon{{
				{426714.5752302991, -668548.9238652373},
				{426744.63718662335, -668550.0591896093},
				{426745.3964821229, -668550.4652243527},
			}},
			expected: Polygon{
				{
					{426731.5895193888, -668549.5664294426},
					{426714.57523030025, -668548.9238652373},
					{426694.6365274183, -668547.1611580737},
				},
				{
					{426745.39648089616, -668550.4651249861},
					{426745.3962772624, -668550.4651148032},
					{426745.39627072256, -668550.4651113059},
				},
			},
		},
		{
			name:     "subtract self-intersect (requires Simplify() on inputs to fix)",
			subject:  Polygon{{{0, 0}, {1, 0}, {1, 1}, {0, 1}}, {{1, 0}, {2, 0}, {2, 1}, {1, 1}}}.Simplify(),
			clipping: Polygon{{{0, 0.25}, {3, 0.25}, {3, 0.75}, {0, 0.75}}}.Simplify(),
			expected: Polygon{
				{{0, 0.25}, {0, 0}, {1, 0}, {2, 0}, {2, 0.25}},
				{{1, 1}, {0, 1}, {0, 0.75}, {2, 0.75}, {2, 1}},
			},
		},
	}
	for i, test := range tests {
		check.Equal(t, test.expected, test.subject.Subtract(test.clipping), "test case %d (%s)", i, test.name)
	}
}
