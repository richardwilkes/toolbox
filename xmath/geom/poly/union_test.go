// Copyright Â©2016-2023 by Richard A. Wilkes. All rights reserved.
//
// This Source Code Form is subject to the terms of the Mozilla Public
// License, version 2.0. If a copy of the MPL was not distributed with
// this file, You can obtain one at http://mozilla.org/MPL/2.0/.
//
// This Source Code Form is "Incompatible With Secondary Licenses", as
// defined by the Mozilla Public License, version 2.0.

package poly_test

import (
	"testing"

	"github.com/richardwilkes/toolbox/check"
)

func TestUnion(t *testing.T) {
	tests := []testCase{
		{
			name:    "union #1",
			subject: Polygon{{{1, 1}, {1, 2}, {2, 2}, {2, 1}}},
			clipping: Polygon{
				{{2, 1}, {2, 2}, {3, 2}, {3, 1}},
				{{1, 2}, {1, 3}, {2, 3}, {2, 2}},
				{{2, 2}, {2, 3}, {3, 3}, {3, 2}},
			},
			expected: Polygon{{{2, 3}, {1, 3}, {1, 2}, {1, 1}, {2, 1}, {3, 1}, {3, 2}, {3, 3}}},
		},
		{
			name:    "union #2",
			subject: Polygon{{{1, 2}, {2, 2}, {2, 1}}},
			clipping: Polygon{
				{{2, 1}, {2, 2}, {3, 2}},
				{{1, 2}, {2, 3}, {2, 2}},
				{{2, 2}, {2, 3}, {3, 2}},
			},
			expected: Polygon{{{3, 2}, {2, 1}, {1, 2}, {2, 3}}},
		},
		{
			name:    "union #3",
			subject: Polygon{{{1, 2}, {2, 2}, {2, 1}}},
			clipping: Polygon{
				{{1, 2}, {2, 3}, {2, 2}},
				{{2, 2}, {2, 3}, {3, 2}},
			},
			expected: Polygon{{{3, 2}, {2, 2}, {2, 1}, {1, 2}, {2, 3}}},
		},
		{
			name:     "union #4",
			subject:  Polygon{{{1, 2}, {2, 2}, {2, 1}}},
			clipping: Polygon{{{1, 2}, {2, 3}, {2, 2}, {2, 3}, {3, 2}}},
			expected: Polygon{{{3, 2}, {2, 2}, {2, 1}, {1, 2}, {2, 3}}},
		},
		{
			name:    "union #5",
			subject: Polygon{{{1, 2}, {2, 2}, {2, 1}}},
			clipping: Polygon{
				{{2, 1}, {2, 2}, {2, 3}, {3, 2}},
				{{1, 2}, {2, 3}, {2, 2}},
			},
			expected: Polygon{{{3, 2}, {2, 1}, {1, 2}, {2, 3}}},
		},
		{
			name:     "union #6",
			subject:  Polygon{{{1, 2}, {2, 2}, {2, 1}}},
			clipping: Polygon{{{1, 2}, {2, 2}, {2, 3}, {1, 2}, {2, 2}, {2, 3}}},
			expected: Polygon{{{2, 2}, {2, 1}, {1, 2}}},
		},
		{
			name: "union #7",
			subject: Polygon{{
				{160.09449516387843, 200.37992407997774},
				{90.09449516387845, 200.37992407997774},
				{55.094495163878435, 139.75814581506702},
				{90.0944951638784, 79.13636755015634},
			}},
			clipping: Polygon{{
				{82.84661138052363, 131.51881422166852},
				{66.59206311550543, 159.6725176707606},
				{90.09449516387845, 200.37992407997774},
				{160.09449516387843, 200.37992407997774},
			}},
			expected: Polygon{{
				{90.09449516387845, 200.37992407997774},
				{66.59206311550543, 159.6725176707606},
				{55.094495163878435, 139.75814581506702},
				{90.0944951638784, 79.13636755015634},
				{160.09449516387843, 200.37992407997774},
			}},
		},
		{
			name: "union #8",
			subject: Polygon{{
				{70.78432620601497, -7.668842337087888},
				{42.500054958553065, -19.38457108962598},
				{22.504998288170377, -11.102347436334847},
				{14.215783711091163, -7.668842337087877},
				{2.500054958553072, 20.615428910374025},
				{4.163269713667806, 24.63078452931106},
				{-16.386530327112805, 33.142790410257575},
				{-28.102259079650896, 61.42706165771948},
			}},
			clipping: Polygon{{
				{22.504998288170377, -11.102347436334847},
				{14.215783711091163, -7.668842337087877},
				{2.500054958553072, 20.615428910374025},
				{4.163269713667806, 24.63078452931106},
				{-16.386530327112805, 33.142790410257575},
				{-18.453791204657392, 38.133599657789034},
				{-23.270336557414375, 26.505430543378026},
				{16.72966344258562, -13.494569456621978},
				{45.01393469004752, -1.778840704083887},
				{22.504998288170377, -11.102347436334847},
			}},
			expected: Polygon{{
				{-28.102259079650896, 61.42706165771948},
				{-18.453791204657392, 38.133599657789034},
				{-23.270336557414375, 26.505430543378026},
				{16.72966344258562, -13.494569456621978},
				{22.504998288170377, -11.102347436334847},
				{42.500054958553065, -19.38457108962598},
				{70.78432620601497, -7.668842337087888},
			}},
		},
		{
			name: "union #9",
			subject: Polygon{{
				{2.500054958553072, 20.615428910374025},
				{42.500054958553065, -19.38457108962598},
				{82.50005495855308, 20.61542891037402},
				{42.50005495855307, 60.61542891037402},
			}},
			clipping: Polygon{{
				{7.604714313123809, 25.720088264944764},
				{32.55986001707135, 50.6752339688923},
				{36.852886624296644, 46.382207361667014},
				{11.897740920349097, 21.42706165771947},
			}},
			expected: Polygon{{
				{42.50005495855307, 60.61542891037402},
				{32.55986001707135, 50.6752339688923},
				{7.604714313123809, 25.720088264944764},
				{2.500054958553072, 20.615428910374025},
				{42.500054958553065, -19.38457108962598},
				{82.50005495855308, 20.61542891037402},
			}},
		},
		{
			name:     "union #10",
			subject:  Polygon{{{24, 7}, {36, 7}, {36, 23}, {24, 23}}},
			clipping: circle,
			expected: Polygon{{
				{36, 23},
				{36, 7},
				{24, 7},
				{23.16377229385877, 7.043824837053813},
				{22.33670647345792, 7.1748191941295545},
				{21.527864045000413, 7.391547869638772},
				{20.746106855393588, 7.691636338859194},
				{19.99999999999999, 8.071796769724493},
				{19.297717981660202, 8.527864045000424},
				{18.64695514912912, 9.054841396180851},
				{18.05484139618083, 9.646955149129141},
				{17.527864045000403, 10.297717981660224},
				{17.07179676972447, 11.00000000000001},
				{16.691636338859173, 11.746106855393611},
				{16.39154786963875, 12.527864045000435},
				{16.174819194129533, 13.33670647345794},
				{16.04382483705379, 14.16377229385879},
				{15.999999999999977, 15.00000000000002},
				{16.04382483705379, 15.83622770614125},
				{16.174819194129533, 16.6632935265421},
				{16.39154786963875, 17.472135954999604},
				{16.691636338859173, 18.25389314460643},
				{17.07179676972447, 19.00000000000003},
				{17.527864045000403, 19.702282018339815},
				{18.05484139618083, 20.353044850870898},
				{18.64695514912912, 20.945158603819188},
				{19.297717981660202, 21.472135954999615},
				{19.99999999999999, 21.928203230275546},
				{20.746106855393588, 22.308363661140845},
				{21.527864045000413, 22.608452130361268},
				{22.33670647345792, 22.825180805870485},
				{23.16377229385877, 22.956175162946227},
				{24, 23.00000000000004},
			}},
		},
		{
			name:     "union overlapping segments #1",
			subject:  Polygon{{{0, 0}, {10, 0}, {0, 10}}},
			clipping: Polygon{{{6, 5}, {6, 4}, {5, 5}}},
			expected: Polygon{{{6, 4}, {6, 5}, {5, 5}, {0, 10}, {0, 0}, {10, 0}}},
		},
		{
			name:     "union overlapping segments #2",
			subject:  Polygon{{{0, 0}, {10, 0}, {0, 10}}},
			clipping: Polygon{{{6, 4}, {4, 5}, {5, 5}}},
			expected: Polygon{{{6, 4}, {5, 5}, {0, 10}, {0, 0}, {10, 0}}},
		},
		{
			name:     "union overlapping segments #3",
			subject:  Polygon{{{0, 10}, {10, 10}, {0, 0}}},
			clipping: Polygon{{{6, 5}, {6, 6}, {5, 5}}},
			expected: Polygon{{{0, 10}, {0, 0}, {5, 5}, {6, 5}, {6, 6}, {10, 10}}},
		},
		{
			name:     "union overlapping segments #4",
			subject:  Polygon{{{0, 10}, {10, 10}, {0, 0}}},
			clipping: Polygon{{{5, 5}, {5, 6}, {6, 6}}},
			expected: Polygon{{{0, 10}, {0, 0}, {5, 5}, {6, 6}, {10, 10}}},
		},
		{
			name:     "union overlapping segments #5",
			subject:  Polygon{{{40131, 8372}, {40127, 8374}, {40126, 8375}, {40125, 8375}, {40122, 8377}, {40143, 8369}}},
			clipping: Polygon{{{40106, 8376}, {40128, 8373}, {40126, 8375}}},
			expected: Polygon{{{40122, 8377}, {40124.91891891892, 8375.054054054053}, {40106, 8376}, {40128, 8373}, {40127, 8374}, {40131, 8372}, {40143, 8369}}},
		},
		{
			name: "union shared vertex #1",
			subject: Polygon{
				{{0, 6}, {5, 5}, {2, 10}},
				{{4, 0}, {10, 4}, {5, 5}},
			},
			clipping: Polygon{{{5, 5}, {10, 8}, {8, 10}}},
			expected: Polygon{{{8, 10}, {5, 5}, {2, 10}, {0, 6}, {5, 5}, {4, 0}, {10, 4}, {5, 5}, {10, 8}}},
		},
		{
			name: "union shared vertex #2",
			subject: Polygon{
				{{0, 6}, {5, 5}, {5, 10}},
				{{5, 0}, {10, 4}, {5, 5}},
			},
			clipping: Polygon{{{5, 5}, {10, 8}, {8, 10}}},
			expected: Polygon{{{8, 10}, {5, 5}, {5, 10}, {0, 6}, {5, 5}, {5, 0}, {10, 4}, {5, 5}, {10, 8}}},
		},
		{
			name: "union shared vertex #3",
			subject: Polygon{
				{{0, 6}, {5, 5}, {2, 10}},
				{{6, 0}, {10, 4}, {5, 5}},
			},
			clipping: Polygon{{{5, 5}, {10, 8}, {8, 10}}},
			expected: Polygon{
				{{2, 10}, {0, 6}, {5, 5}},
				{{10, 8}, {5, 5}, {10, 4}, {6, 0}, {5, 5}, {8, 10}},
			},
		},
		{
			name:     "union self-intersection",
			subject:  Polygon{{{0, 0}, {1, 0}, {1, 1}, {0, 1}}, {{1, 0}, {2, 0}, {2, 1}, {1, 1}}},
			clipping: Polygon{{{0, 0.25}, {3, 0.25}, {3, 0.75}, {0, 0.75}}},
			expected: Polygon{{{2, 0.75}, {2, 1}, {1, 1}, {0, 1}, {0, 0.75}, {0, 0.25}, {0, 0}, {1, 0}, {2, 0}, {2, 0.25}, {3, 0.25}, {3, 0.75}}},
		},
	}
	for i, test := range tests {
		check.Equal(t, test.expected, test.subject.Union(test.clipping), "test case %d (%s)", i, test.name)
	}
}
