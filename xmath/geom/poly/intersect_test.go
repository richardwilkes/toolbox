// Copyright Â©2016-2023 by Richard A. Wilkes. All rights reserved.
//
// This Source Code Form is subject to the terms of the Mozilla Public
// License, version 2.0. If a copy of the MPL was not distributed with
// this file, You can obtain one at http://mozilla.org/MPL/2.0/.
//
// This Source Code Form is "Incompatible With Secondary Licenses", as
// defined by the Mozilla Public License, version 2.0.

package poly_test

import (
	"testing"

	"github.com/richardwilkes/toolbox/check"
)

func TestIntersect(t *testing.T) {
	tests := []testCase{
		{
			name: "intersect #1",
			subject: Polygon{{
				{160.09449516387843, 200.37992407997774},
				{90.09449516387845, 200.37992407997774},
				{55.094495163878435, 139.75814581506702},
				{90.0944951638784, 79.13636755015634},
			}},
			clipping: Polygon{{
				{82.84661138052363, 131.51881422166852},
				{66.59206311550543, 159.6725176707606},
				{90.09449516387845, 200.37992407997774},
				{160.09449516387843, 200.37992407997774},
			}},
			expected: Polygon{{
				{160.09449516387843, 200.37992407997774},
				{82.84661138052363, 131.51881422166852},
				{66.59206311550543, 159.6725176707606},
				{90.09449516387845, 200.37992407997774},
			}},
		},
		{
			name: "intersect #2",
			subject: Polygon{{
				{131.59597133486625, 287.9385241571817},
				{100.00000000000004, 273.20508075688775},
				{71.44247806269215, 253.20888862379562},
				{71.44247806269209, -53.20888862379559},
				{99.99999999999991, -73.20508075688767},
				{131.59597133486614, -87.93852415718163},
			}},
			clipping: Polygon{{
				{128.55752193730785, -53.208888623795616},
				{100, -73.20508075688772},
				{99.99999999999991, -73.20508075688767},
				{71.44247806269209, -53.20888862379559},
				{71.44247806269215, 253.20888862379562},
				{100.00000000000003, 273.2050807568877},
				{128.55752193730788, 253.20888862379562},
			}},
			expected: Polygon{{
				{100.00000000000003, 273.2050807568877},
				{71.44247806269215, 253.20888862379562},
				{71.44247806269209, -53.20888862379559},
				{99.99999999999991, -73.20508075688767},
				{100, -73.20508075688772},
				{128.55752193730785, -53.208888623795616},
				{128.55752193730788, 253.20888862379562},
			}},
		},
		{
			name: "intersect #3",
			subject: Polygon{{
				{100.0000001, 100},
				{98.48077539970159, 117.36481778405785},
				{98.48077539970159, 82.63518221594214},
			}},
			clipping: Polygon{{
				{100.0000001, 100},
				{100, 99.99999885699484},
				{99.9999999, 100.00000000000001},
				{100, 100.00000114300516},
				{100.0000001, 100},
			}},
			expected: Polygon{{
				{100.0000001, 100},
				{100, 99.99999885699484},
				{99.9999999, 100.00000000000001},
				{100, 100.00000114300516},
			}},
		},
		{
			name: "intersect #4",
			subject: Polygon{{
				{100.00000001, 100},
				{98.48077531106888, 117.36481776842952},
				{98.48077531106888, 82.63518223157048},
			}},
			clipping: Polygon{{
				{100.00000001, 100},
				{100, 99.99999988569955},
				{99.99999998, 100.00000000000001},
				{100, 100.00000011430046},
				{100.00000001, 100},
			}},
			expected: Polygon{{
				{100.00000001, 100},
				{100, 99.99999988569955},
				{99.99999998, 100.00000000000001},
				{100, 100.00000011430046},
			}},
		},
		{
			name: "intersect #5",
			subject: Polygon{{
				{2.500054958553072, 20.615428910374025},
				{42.500054958553065, -19.38457108962598},
				{82.50005495855308, 20.61542891037402},
				{42.50005495855307, 60.61542891037402},
			}},
			clipping: Polygon{{
				{7.604714313123809, 25.720088264944764},
				{11.897740920349097, 21.42706165771947},
				{36.852886624296644, 46.382207361667014},
				{32.55986001707135, 50.6752339688923},
			}},
			expected: Polygon{{
				{36.852886624296644, 46.382207361667014},
				{11.897740920349097, 21.42706165771947},
				{7.604714313123809, 25.720088264944764},
				{32.55986001707135, 50.6752339688923},
			}},
		},
		{
			name: "intersect #6",
			subject: Polygon{{
				{300, -100},
				{259.8076211353316, 49.99999999999997},
				{-259.80762113533154, 50.000000000000114},
				{-300, -99.99999999999996},
			}},
			clipping: Polygon{{
				{273.2050807568877, 7.815970093361102e-14},
				{259.8076211353315, -50.00000000000014},
				{-259.80762113533166, -49.99999999999994},
				{-273.20508075688775, -7.105427357601002e-14},
				{-259.80762113533154, 50.000000000000114},
				{259.8076211353316, 49.99999999999997},
			}},
			expected: Polygon{{
				{273.2050807568877, 7.815970093361102e-14},
				{259.8076211353315, -50.00000000000014},
				{-259.80762113533166, -49.99999999999994},
				{-273.20508075688775, -7.105427357601002e-14},
				{-259.80762113533154, 50.000000000000114},
				{259.8076211353316, 49.99999999999997},
			}},
		},
		{
			name: "intersect #7",
			subject: Polygon{{
				{300, -100},
				{277.163859753386, 14.805029709526934},
				{-277.163859753386, 14.805029709526949},
				{-300, -99.99999999999996},
			}},
			clipping: Polygon{{
				{280.1087632620342, 4.618527782440651e-14},
				{277.16385975338596, -14.805029709527119},
				{-277.1638597533861, -14.805029709526906},
				{-280.10876326203424, -1.1368683772161603e-13},
				{-277.163859753386, 14.805029709526949},
				{277.163859753386, 14.805029709526934},
				{280.1087632620342, 4.618527782440651e-14},
			}},
			expected: Polygon{{
				{280.1087632620342, 4.618527782440651e-14},
				{277.16385975338596, -14.805029709527119},
				{-277.1638597533861, -14.805029709526906},
				{-280.10876326203424, -1.1368683772161603e-13},
				{-277.163859753386, 14.805029709526949},
				{277.163859753386, 14.805029709526934},
			}},
		},
		{
			name: "intersect #8",
			subject: Polygon{{
				{-196.96155060244163, 65.270364466614},
				{-187.9385241571817, 31.595971334866263},
				{-173.20508075688775, 4.263256414560601e-14},
				{-153.20888862379562, -28.557521937307854},
				{153.2088886237956, -28.55752193730791},
				{173.20508075688767, -8.526512829121202e-14},
				{187.93852415718163, 31.59597133486612},
				{196.96155060244163, 65.27036446661393},
			}},
			clipping: Polygon{{
				{196.96155060244163, -65.27036446661393},
				{187.9385241571817, -31.595971334866263},
				{173.20508075688775, -1.4210854715202004e-14},
				{153.20888862379562, 28.557521937307854},
				{-153.2088886237956, 28.557521937307882},
				{-173.20508075688775, -1.4210854715202004e-14},
				{-187.93852415718166, -31.59597133486622},
				{-196.9615506024416, -65.27036446661387},
			}},
			expected: Polygon{{
				{173.20508075688775, -1.4210854715202004e-14},
				{173.20508075688767, -8.526512829121202e-14},
				{153.2088886237956, -28.55752193730791},
				{-153.20888862379562, -28.557521937307854},
				{-173.20508075688775, 4.263256414560601e-14},
				{-153.2088886237956, 28.557521937307882},
				{153.20888862379562, 28.557521937307854},
			}},
		},
		{
			name: "intersect #9",
			subject: Polygon{{
				{128.55752193730788, 253.20888862379562},
				{100.00000000000003, 273.2050807568877},
				{68.40402866513377, 287.9385241571817},
				{68.40402866513364, -87.93852415718172},
				{100, -73.20508075688772},
				{128.55752193730785, -53.208888623795616},
			}},
			clipping: Polygon{{
				{131.59597133486625, 287.9385241571817},
				{100.00000000000004, 273.20508075688775},
				{71.44247806269215, 253.20888862379562},
				{71.44247806269209, -53.20888862379559},
				{99.99999999999991, -73.20508075688767},
				{131.59597133486614, -87.93852415718163},
			}},
			expected: Polygon{{
				{100.00000000000003, 273.2050807568877},
				{71.44247806269215, 253.20888862379562},
				{71.44247806269209, -53.20888862379559},
				{99.99999999999991, -73.20508075688767},
				{100, -73.20508075688772},
				{128.55752193730785, -53.208888623795616},
				{128.55752193730788, 253.20888862379562},
			}},
		},
		{
			name:     "intersect #10",
			subject:  Polygon{{{24, 7}, {36, 7}, {36, 23}, {24, 23}}},
			clipping: circle,
			expected: Polygon{{
				{31.95617516294621, 15.83622770614125},
				{31.825180805870467, 16.6632935265421},
				{31.60845213036125, 17.472135954999604},
				{31.308363661140827, 18.25389314460643},
				{30.92820323027553, 19.00000000000003},
				{30.472135954999597, 19.702282018339815},
				{29.94515860381917, 20.353044850870898},
				{29.35304485087088, 20.945158603819188},
				{28.702282018339798, 21.472135954999615},
				{28.00000000000001, 21.928203230275546},
				{27.253893144606412, 22.308363661140845},
				{26.472135954999587, 22.608452130361268},
				{25.66329352654208, 22.825180805870485},
				{24.83622770614123, 22.956175162946227},
				{24, 23.00000000000004},
				{24, 23},
				{24, 7},
				{24.83622770614123, 7.043824837053814},
				{25.66329352654208, 7.174819194129555},
				{26.472135954999587, 7.391547869638773},
				{27.253893144606412, 7.691636338859195},
				{28.00000000000001, 8.071796769724493},
				{28.702282018339798, 8.527864045000424},
				{29.35304485087088, 9.054841396180851},
				{29.94515860381917, 9.646955149129141},
				{30.472135954999597, 10.297717981660224},
				{30.92820323027553, 11.00000000000001},
				{31.308363661140827, 11.746106855393611},
				{31.60845213036125, 12.527864045000435},
				{31.825180805870467, 13.33670647345794},
				{31.95617516294621, 14.16377229385879},
				{32.00000000000002, 15.00000000000002},
			}},
		},
		{
			name:     "intersect #11",
			subject:  Polygon{{{1568, 360.5}, {1567.2041, 392.66965}, {1564.8181, 424.76056}, {1560.8481, 456.69424}, {1555.3038, 488.3925}, {1548.1987, 519.7778}, {1539.55, 550.7733}, {1529.3793, 581.30316}, {1517.711, 611.2927}, {1504.574, 640.6685}, {1490.0002, 669.3587}, {1474.0255, 697.2931}, {1456.689, 724.4032}, {1438.0328, 750.6228}, {1418.1029, 775.8878}, {1396.9479, 800.1361}, {1374.6196, 823.3087}, {1351.1727, 845.34863}, {1326.6646, 866.20215}, {1301.155, 885.81805}, {1274.7067, 904.14844}, {1247.3842, 921.14844}, {1219.2544, 936.7764}, {1190.3861, 950.9942}, {1160.8501, 963.7669}, {1130.7186, 975.06335}, {1100.0653, 984.8558}, {1068.9652, 993.12036}, {1037.4944, 999.83685}, {1005.73004, 1004.9888}, {973.7497, 1008.5634}, {941.6318, 1010.55225}, {909.4547, 1010.95026}, {877.2974, 1009.75653}, {845.23846, 1006.97394}, {813.3563, 1002.6093}, {781.7291, 996.67334}, {750.4341, 989.18054}, {719.548, 980.1493}, {689.14624, 969.6016}, {659.3033, 957.5634}, {630.09216, 944.064}, {601.58435, 929.1366}, {573.8496, 912.81757}, {546.95593, 895.1469}, {520.969, 876.1679}, {495.95242, 855.927}, {471.96744, 834.47363}, {449.07278, 811.86035}, {427.32446, 788.1426}, {406.77567, 763.3783}, {387.47675, 737.62805}, {369.4748, 710.95496}, {352.8141, 683.4242}, {337.53516, 655.10315}, {323.67554, 626.0613}, {311.26917, 596.3694}, {300.34625, 566.10034}, {290.93372, 535.3282}, {283.05444, 504.12817}, {276.72772, 472.57666}, {271.96918, 440.75092}, {268.79034, 408.72873}, {267.19897, 376.58856}, {267.19904, 344.409}, {268.79047, 312.26883}, {271.96948, 280.24667}, {276.72815, 248.42093}, {283.055, 216.86945}, {290.93433, 185.66945}, {300.34705, 154.89732}, {311.27002, 124.62831}, {323.67657, 94.93652}, {337.53625, 65.89465}, {352.81525, 37.5737}, {369.47614, 10.042999}, {387.47815, -16.630066}, {406.7772, -42.38022}, {427.32608, -67.14444}, {449.0745, -90.86218}, {471.96924, -113.47528}, {495.95428, -134.92856}, {520.9708, -155.16931}, {546.95764, -174.14813}, {573.8513, -191.8186}, {601.58594, -208.13745}, {630.0936, -223.06476}, {659.3047, -236.56403}, {689.1476, -248.60211}, {719.54926, -259.14972}, {750.4353, -268.18085}, {781.7303, -275.67358}, {813.3575, -281.6095}, {845.2395, -285.974}, {877.2984, -288.75653}, {909.4556, -289.95026}, {941.63257, -289.5522}, {973.7504, -287.56335}, {1005.73065, -283.98865}, {1037.495, -278.83673}, {1068.9657, -272.12024}, {1100.0657, -263.85565}, {1130.7189, -254.06323}, {1160.8503, -242.76678}, {1190.3864, -229.99414}, {1219.2544, -215.77643}, {1247.3843, -200.14844}, {1274.7067, -183.1485}, {1301.1549, -164.81818}, {1326.6643, -145.20227}, {1351.1725, -124.34885}, {1374.6194, -102.30896}, {1396.9476, -79.136505}, {1418.1025, -54.888153}, {1438.0325, -29.623291}, {1456.6886, -3.4037476}, {1474.0251, 23.70633}, {1489.9999, 51.640564}, {1504.5736, 80.33066}, {1517.7107, 109.70636}, {1529.3789, 139.69579}, {1539.5498, 170.22556}, {1548.1984, 201.22096}, {1555.3036, 232.60616}, {1560.848, 264.30432}, {1564.8181, 296.23785}, {1567.204, 328.3287}}},
			clipping: Polygon{{{449, 399}, {400, 350}, {267, 347}, {267, -290}, {267, -290}, {1567, -290}, {1567, -291}, {1567, 1010}, {1567, 1010}, {268, 1010}, {267, 1010}, {267, 415}}},
			expected: Polygon{{{1567, 395.4147274228825}, {1567, 325.5848576763492}, {1564.8181, 296.23785}, {1560.848, 264.30432}, {1555.3036, 232.60616}, {1548.1984, 201.22096}, {1539.5498, 170.22556}, {1529.3789, 139.69579}, {1517.7107, 109.70636}, {1504.5736, 80.33066}, {1489.9999, 51.640564}, {1474.0251, 23.70633}, {1456.6886, -3.4037476}, {1438.0325, -29.623291}, {1418.1025, -54.888153}, {1396.9476, -79.136505}, {1374.6194, -102.30896}, {1351.1725, -124.34885}, {1326.6643, -145.20227}, {1301.1549, -164.81818}, {1274.7067, -183.1485}, {1247.3843, -200.14844}, {1219.2544, -215.77643}, {1190.3864, -229.99414}, {1160.8503, -242.76678}, {1130.7189, -254.06323}, {1100.0657, -263.85565}, {1068.9657, -272.12024}, {1037.495, -278.83673}, {1005.73065, -283.98865}, {973.7504, -287.56335}, {941.63257, -289.5522}, {909.4556, -289.95026}, {877.2984, -288.75653}, {845.2395, -285.974}, {813.3575, -281.6095}, {781.7303, -275.67358}, {750.4353, -268.18085}, {719.54926, -259.14972}, {689.1476, -248.60211}, {659.3047, -236.56403}, {630.0936, -223.06476}, {601.58594, -208.13745}, {573.8513, -191.8186}, {546.95764, -174.14813}, {520.9708, -155.16931}, {495.95428, -134.92856}, {471.96924, -113.47528}, {449.0745, -90.86218}, {427.32608, -67.14444}, {406.7772, -42.38022}, {387.47815, -16.630066}, {369.47614, 10.042999}, {352.81525, 37.5737}, {337.53625, 65.89465}, {323.67657, 94.93652}, {311.27002, 124.62831}, {300.34705, 154.89732}, {290.93433, 185.66945}, {283.055, 216.86945}, {276.72815, 248.42093}, {271.96948, 280.24667}, {268.79047, 312.26883}, {267.19904, 344.409}, {267.19903435404757, 347.00448949670783}, {400, 350}, {449, 399}, {269.3920132640723, 414.789713119642}, {271.96918, 440.75092}, {276.72772, 472.57666}, {283.05444, 504.12817}, {290.93372, 535.3282}, {300.34625, 566.10034}, {311.26917, 596.3694}, {323.67554, 626.0613}, {337.53516, 655.10315}, {352.8141, 683.4242}, {369.4748, 710.95496}, {387.47675, 737.62805}, {406.77567, 763.3783}, {427.32446, 788.1426}, {449.07278, 811.86035}, {471.96744, 834.47363}, {495.95242, 855.927}, {520.969, 876.1679}, {546.95593, 895.1469}, {573.8496, 912.81757}, {601.58435, 929.1366}, {630.09216, 944.064}, {659.3033, 957.5634}, {689.14624, 969.6016}, {719.548, 980.1493}, {750.4341, 989.18054}, {781.7291, 996.67334}, {813.3563, 1002.6093}, {845.23846, 1006.97394}, {877.2974, 1009.75653}, {883.8561174913929, 1010}, {950.550074517937, 1010}, {973.7497, 1008.5634}, {1005.73004, 1004.9888}, {1037.4944, 999.83685}, {1068.9652, 993.12036}, {1100.0653, 984.8558}, {1130.7186, 975.06335}, {1160.8501, 963.7669}, {1190.3861, 950.9942}, {1219.2544, 936.7764}, {1247.3842, 921.14844}, {1274.7067, 904.14844}, {1301.155, 885.81805}, {1326.6646, 866.20215}, {1351.1727, 845.34863}, {1374.6196, 823.3087}, {1396.9479, 800.1361}, {1418.1029, 775.8878}, {1438.0328, 750.6228}, {1456.689, 724.4032}, {1474.0255, 697.2931}, {1490.0002, 669.3587}, {1504.574, 640.6685}, {1517.711, 611.2927}, {1529.3793, 581.30316}, {1539.55, 550.7733}, {1548.1987, 519.7778}, {1555.3038, 488.3925}, {1560.8481, 456.69424}, {1564.8181, 424.76056}}},
		},
		{
			name:     "intersect self-intersection (requires Simplify() on inputs to fix)",
			subject:  Polygon{{{0, 0}, {1, 0}, {1, 1}, {0, 1}}, {{1, 0}, {2, 0}, {2, 1}, {1, 1}}}.Simplify(),
			clipping: Polygon{{{0, 0.25}, {3, 0.25}, {3, 0.75}, {0, 0.75}}}.Simplify(),
			expected: Polygon{{{0, 0.75}, {0, 0.25}, {2, 0.25}, {2, 0.75}}},
		},
	}
	for i, test := range tests {
		check.Equal(t, test.expected, test.subject.Intersect(test.clipping), "test case %d (%s)", i, test.name)
	}
}
