// Copyright Â©2016-2023 by Richard A. Wilkes. All rights reserved.
//
// This Source Code Form is subject to the terms of the Mozilla Public
// License, version 2.0. If a copy of the MPL was not distributed with
// this file, You can obtain one at http://mozilla.org/MPL/2.0/.
//
// This Source Code Form is "Incompatible With Secondary Licenses", as
// defined by the Mozilla Public License, version 2.0.

package poly_test

import (
	"testing"

	"github.com/stretchr/testify/assert"
)

func TestIntersect(t *testing.T) {
	tests := []testCase{
		{
			name: "intersect #1",
			subject: Polygon{{
				{160.09449516387843, 200.37992407997774},
				{90.09449516387845, 200.37992407997774},
				{55.094495163878435, 139.75814581506702},
				{90.0944951638784, 79.13636755015634},
			}},
			clipping: Polygon{{
				{82.84661138052363, 131.51881422166852},
				{66.59206311550543, 159.6725176707606},
				{90.09449516387845, 200.37992407997774},
				{160.09449516387843, 200.37992407997774},
			}},
			expected: Polygon{{
				{160.09449516387843, 200.37992407997774},
				{82.84661138052363, 131.51881422166852},
				{66.59206311550543, 159.6725176707606},
				{90.09449516387845, 200.37992407997774},
			}},
		},
		{
			name: "intersect #2",
			subject: Polygon{{
				{131.59597133486625, 287.9385241571817},
				{100.00000000000004, 273.20508075688775},
				{71.44247806269215, 253.20888862379562},
				{71.44247806269209, -53.20888862379559},
				{99.99999999999991, -73.20508075688767},
				{131.59597133486614, -87.93852415718163},
			}},
			clipping: Polygon{{
				{128.55752193730785, -53.208888623795616},
				{100, -73.20508075688772},
				{99.99999999999991, -73.20508075688767},
				{71.44247806269209, -53.20888862379559},
				{71.44247806269215, 253.20888862379562},
				{100.00000000000003, 273.2050807568877},
				{128.55752193730788, 253.20888862379562},
			}},
			expected: Polygon{{
				{100.00000000000003, 273.2050807568877},
				{71.44247806269215, 253.20888862379562},
				{71.44247806269209, -53.20888862379559},
				{99.99999999999991, -73.20508075688767},
				{100, -73.20508075688772},
				{128.55752193730785, -53.208888623795616},
				{128.55752193730788, 253.20888862379562},
			}},
		},
		{
			name: "intersect #3",
			subject: Polygon{{
				{100.0000001, 100},
				{98.48077539970159, 117.36481778405785},
				{98.48077539970159, 82.63518221594214},
			}},
			clipping: Polygon{{
				{100.0000001, 100},
				{100, 99.99999885699484},
				{99.9999999, 100.00000000000001},
				{100, 100.00000114300516},
				{100.0000001, 100},
			}},
			expected: Polygon{{
				{100.0000001, 100},
				{100, 99.99999885699484},
				{99.9999999, 100.00000000000001},
				{100, 100.00000114300516},
			}},
		},
		{
			name: "intersect #4",
			subject: Polygon{{
				{100.00000001, 100},
				{98.48077531106888, 117.36481776842952},
				{98.48077531106888, 82.63518223157048},
			}},
			clipping: Polygon{{
				{100.00000001, 100},
				{100, 99.99999988569955},
				{99.99999998, 100.00000000000001},
				{100, 100.00000011430046},
				{100.00000001, 100},
			}},
			expected: Polygon{{
				{100.00000001, 100},
				{100, 99.99999988569955},
				{99.99999998, 100.00000000000001},
				{100, 100.00000011430046},
			}},
		},
		{
			name: "intersect #5",
			subject: Polygon{{
				{2.500054958553072, 20.615428910374025},
				{42.500054958553065, -19.38457108962598},
				{82.50005495855308, 20.61542891037402},
				{42.50005495855307, 60.61542891037402},
			}},
			clipping: Polygon{{
				{7.604714313123809, 25.720088264944764},
				{11.897740920349097, 21.42706165771947},
				{36.852886624296644, 46.382207361667014},
				{32.55986001707135, 50.6752339688923},
			}},
			expected: Polygon{{
				{36.852886624296644, 46.382207361667014},
				{11.897740920349097, 21.42706165771947},
				{7.604714313123809, 25.720088264944764},
				{32.55986001707135, 50.6752339688923},
			}},
		},
		{
			name: "intersect #6",
			subject: Polygon{{
				{300, -100},
				{259.8076211353316, 49.99999999999997},
				{-259.80762113533154, 50.000000000000114},
				{-300, -99.99999999999996},
			}},
			clipping: Polygon{{
				{273.2050807568877, 7.815970093361102e-14},
				{259.8076211353315, -50.00000000000014},
				{-259.80762113533166, -49.99999999999994},
				{-273.20508075688775, -7.105427357601002e-14},
				{-259.80762113533154, 50.000000000000114},
				{259.8076211353316, 49.99999999999997},
			}},
			expected: Polygon{{
				{273.2050807568877, 7.815970093361102e-14},
				{259.8076211353315, -50.00000000000014},
				{-259.80762113533166, -49.99999999999994},
				{-273.20508075688775, -7.105427357601002e-14},
				{-259.80762113533154, 50.000000000000114},
				{259.8076211353316, 49.99999999999997},
			}},
		},
		{
			name: "intersect #7",
			subject: Polygon{{
				{300, -100},
				{277.163859753386, 14.805029709526934},
				{-277.163859753386, 14.805029709526949},
				{-300, -99.99999999999996},
			}},
			clipping: Polygon{{
				{280.1087632620342, 4.618527782440651e-14},
				{277.16385975338596, -14.805029709527119},
				{-277.1638597533861, -14.805029709526906},
				{-280.10876326203424, -1.1368683772161603e-13},
				{-277.163859753386, 14.805029709526949},
				{277.163859753386, 14.805029709526934},
				{280.1087632620342, 4.618527782440651e-14},
			}},
			expected: Polygon{{
				{280.1087632620342, 4.618527782440651e-14},
				{277.16385975338596, -14.805029709527119},
				{-277.1638597533861, -14.805029709526906},
				{-280.10876326203424, -1.1368683772161603e-13},
				{-277.163859753386, 14.805029709526949},
				{277.163859753386, 14.805029709526934},
			}},
		},
		{
			name: "intersect #8",
			subject: Polygon{{
				{-196.96155060244163, 65.270364466614},
				{-187.9385241571817, 31.595971334866263},
				{-173.20508075688775, 4.263256414560601e-14},
				{-153.20888862379562, -28.557521937307854},
				{153.2088886237956, -28.55752193730791},
				{173.20508075688767, -8.526512829121202e-14},
				{187.93852415718163, 31.59597133486612},
				{196.96155060244163, 65.27036446661393},
			}},
			clipping: Polygon{{
				{196.96155060244163, -65.27036446661393},
				{187.9385241571817, -31.595971334866263},
				{173.20508075688775, -1.4210854715202004e-14},
				{153.20888862379562, 28.557521937307854},
				{-153.2088886237956, 28.557521937307882},
				{-173.20508075688775, -1.4210854715202004e-14},
				{-187.93852415718166, -31.59597133486622},
				{-196.9615506024416, -65.27036446661387},
			}},
			expected: Polygon{{
				{173.20508075688775, -1.4210854715202004e-14},
				{173.20508075688767, -8.526512829121202e-14},
				{153.2088886237956, -28.55752193730791},
				{-153.20888862379562, -28.557521937307854},
				{-173.20508075688775, 4.263256414560601e-14},
				{-153.2088886237956, 28.557521937307882},
				{153.20888862379562, 28.557521937307854},
			}},
		},
		{
			name: "intersect #9",
			subject: Polygon{{
				{128.55752193730788, 253.20888862379562},
				{100.00000000000003, 273.2050807568877},
				{68.40402866513377, 287.9385241571817},
				{68.40402866513364, -87.93852415718172},
				{100, -73.20508075688772},
				{128.55752193730785, -53.208888623795616},
			}},
			clipping: Polygon{{
				{131.59597133486625, 287.9385241571817},
				{100.00000000000004, 273.20508075688775},
				{71.44247806269215, 253.20888862379562},
				{71.44247806269209, -53.20888862379559},
				{99.99999999999991, -73.20508075688767},
				{131.59597133486614, -87.93852415718163},
			}},
			expected: Polygon{{
				{100.00000000000003, 273.2050807568877},
				{71.44247806269215, 253.20888862379562},
				{71.44247806269209, -53.20888862379559},
				{99.99999999999991, -73.20508075688767},
				{100, -73.20508075688772},
				{128.55752193730785, -53.208888623795616},
				{128.55752193730788, 253.20888862379562},
			}},
		},
		{
			name:     "intersect #10",
			subject:  Polygon{{{24, 7}, {36, 7}, {36, 23}, {24, 23}}},
			clipping: circle,
			expected: Polygon{{
				{31.95617516294621, 15.83622770614125},
				{31.825180805870467, 16.6632935265421},
				{31.60845213036125, 17.472135954999604},
				{31.308363661140827, 18.25389314460643},
				{30.92820323027553, 19.00000000000003},
				{30.472135954999597, 19.702282018339815},
				{29.94515860381917, 20.353044850870898},
				{29.35304485087088, 20.945158603819188},
				{28.702282018339798, 21.472135954999615},
				{28.00000000000001, 21.928203230275546},
				{27.253893144606412, 22.308363661140845},
				{26.472135954999587, 22.608452130361268},
				{25.66329352654208, 22.825180805870485},
				{24.83622770614123, 22.956175162946227},
				{24, 23.00000000000004},
				{24, 23},
				{24, 7},
				{24.83622770614123, 7.043824837053814},
				{25.66329352654208, 7.174819194129555},
				{26.472135954999587, 7.391547869638773},
				{27.253893144606412, 7.691636338859195},
				{28.00000000000001, 8.071796769724493},
				{28.702282018339798, 8.527864045000424},
				{29.35304485087088, 9.054841396180851},
				{29.94515860381917, 9.646955149129141},
				{30.472135954999597, 10.297717981660224},
				{30.92820323027553, 11.00000000000001},
				{31.308363661140827, 11.746106855393611},
				{31.60845213036125, 12.527864045000435},
				{31.825180805870467, 13.33670647345794},
				{31.95617516294621, 14.16377229385879},
				{32.00000000000002, 15.00000000000002},
			}},
		},
		{
			name:     "intersect self-intersection (requires Simplify() on inputs to fix)",
			subject:  Polygon{{{0, 0}, {1, 0}, {1, 1}, {0, 1}}, {{1, 0}, {2, 0}, {2, 1}, {1, 1}}}.Simplify(),
			clipping: Polygon{{{0, 0.25}, {3, 0.25}, {3, 0.75}, {0, 0.75}}}.Simplify(),
			expected: Polygon{{{0, 0.75}, {0, 0.25}, {2, 0.25}, {2, 0.75}}},
		},
	}
	for i, test := range tests {
		assert.Equal(t, test.expected, test.subject.Intersect(test.clipping), "test case %d (%s)", i, test.name)
	}
}
